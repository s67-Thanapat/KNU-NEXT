<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMUTNB Community - ‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡πÅ‡∏•‡∏∞‡∏ñ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { kmutnb: { main: '#EE3F0B', light: '#FF6B42', bg: '#F2F4F8' } },
                    fontFamily: { sans: ['Prompt', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F2F4F8; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .cat-chip.active { background-color: #EE3F0B; color: white; border-color: #EE3F0B; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px);
            display: none; justify-content: center; align-items: center; z-index: 50;
        }
        .modal-content {
            background: white; width: 90%; max-width: 500px; max-height: 90vh;
            border-radius: 20px; padding: 24px; animation: slideUp 0.3s ease-out;
            display: flex; flex-direction: column;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="font-sans text-gray-800 h-screen flex flex-col overflow-hidden">

    <header class="bg-white shadow-sm z-20 h-16 flex items-center justify-between px-4 shrink-0 relative">
        <div class="flex items-center gap-3">
            <a href="index.html" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 transition">
                <i class="fa-solid fa-arrow-left"></i>
            </a>
            <div>
                <h1 class="text-lg font-bold text-gray-800 leading-none">Community</h1>
                <span class="text-xs text-gray-500" id="display-username">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button id="admin-settings-btn" onclick="openSettingsModal()" class="hidden bg-gray-600 hover:bg-gray-700 text-white w-10 h-10 rounded-full text-sm font-bold shadow-md transition items-center justify-center">
                <i class="fa-solid fa-gear"></i>
            </button>
            <button onclick="openMyPostsModal()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-full text-sm font-bold shadow-sm transition flex items-center gap-2 border border-gray-200">
                <i class="fa-solid fa-clock-rotate-left"></i> <span class="hidden sm:inline">‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
            </button>
            <button onclick="openCreateModal()" class="bg-kmutnb-main hover:bg-orange-700 text-white px-4 py-2 rounded-full text-sm font-bold shadow-md transition flex items-center gap-2">
                <i class="fa-solid fa-pen"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ
            </button>
            <button id="admin-reports-btn" onclick="openAdminReportsModal()" class="hidden relative bg-red-100 hover:bg-red-200 text-red-600 w-10 h-10 rounded-full text-sm font-bold transition flex items-center justify-center">
                <i class="fa-solid fa-bell"></i>
                <span id="report-badge" class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden border-2 border-white">0</span>
            </button>
        </div>
    </header>

    <div class="bg-white px-4 py-3 shadow-sm z-10 shrink-0">
        <div class="relative max-w-3xl mx-auto mb-3">
            <input type="text" id="search-input" oninput="handleSearch()" class="w-full h-11 pl-11 pr-4 bg-gray-100 rounded-full border-0 outline-none focus:ring-2 focus:ring-kmutnb-main text-gray-700 text-sm" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ, ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°, ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß...">
            <div class="absolute left-4 top-3 text-gray-400"><i class="fa-solid fa-magnifying-glass"></i></div>
        </div>
        
        <div class="flex gap-2 overflow-x-auto hide-scrollbar max-w-3xl mx-auto pb-1">
            <button class="cat-chip active px-4 py-1.5 rounded-full text-sm font-medium border border-gray-200 bg-white text-gray-600 whitespace-nowrap" onclick="setCategory('all', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button class="cat-chip px-4 py-1.5 rounded-full text-sm font-medium border border-gray-200 bg-white text-gray-600 whitespace-nowrap" onclick="setCategory('study', this)">üìö ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
            <button class="cat-chip px-4 py-1.5 rounded-full text-sm font-medium border border-gray-200 bg-white text-gray-600 whitespace-nowrap" onclick="setCategory('food', this)">üçú ‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏ô</button>
            <button class="cat-chip px-4 py-1.5 rounded-full text-sm font-medium border border-gray-200 bg-white text-gray-600 whitespace-nowrap" onclick="setCategory('friend', this)">üë• ‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</button>
            <button class="cat-chip px-4 py-1.5 rounded-full text-sm font-medium border border-gray-200 bg-white text-gray-600 whitespace-nowrap" onclick="setCategory('general', this)">üí¨ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</button>
        </div>
    </div>

    <main class="flex-1 overflow-y-auto p-4 pb-20">
        <div id="post-feed" class="max-w-3xl mx-auto space-y-4">
            </div>
    </main>

    <div id="myPostsModal" class="modal-overlay" onclick="if(event.target == this) closeMyPostsModal()">
        <div class="modal-content h-[85vh] !p-0 overflow-hidden relative flex flex-col">
            <div class="flex justify-between items-center p-4 border-b bg-white shrink-0 z-10">
                <h2 class="text-lg font-bold text-gray-800"><i class="fa-solid fa-clock-rotate-left"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                <button onclick="closeMyPostsModal()" class="text-gray-400 hover:text-red-500 w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="overflow-y-auto flex-1 p-4 bg-gray-50 hide-scrollbar" id="my-posts-list">
                </div>
        </div>
    </div>

    <div id="editPostModal" class="modal-overlay" onclick="if(event.target == this) closeEditPostModal()">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-3 shrink-0">
                <h2 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-pen-to-square"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ (‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</h2>
                <button onclick="closeEditPostModal()" class="text-gray-400 hover:text-red-500 w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="space-y-4 overflow-y-auto pr-2 hide-scrollbar">
                <input type="hidden" id="edit-post-id">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà <span class="text-red-500">*</span></label>
                    <select id="edit-post-category" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:ring-2 focus:ring-kmutnb-main text-sm">
                        <option value="study">üìö ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô / ‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£</option>
                        <option value="food">üçú ‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏ô / ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                        <option value="friend">üë• ‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô / ‡∏´‡∏≠‡∏û‡∏±‡∏Å</option>
                        <option value="general">üí¨ ‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ <span class="text-red-500">*</span></label>
                    <input type="text" id="edit-post-title" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:ring-2 focus:ring-kmutnb-main text-sm">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                    <textarea id="edit-post-content" rows="4" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:ring-2 focus:ring-kmutnb-main text-sm resize-none"></textarea>
                </div>
                <button onclick="submitEditPost()" class="w-full bg-kmutnb-main hover:bg-orange-600 text-white font-bold py-3 rounded-xl transition shadow-md">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay" onclick="if(event.target == this) closeSettingsModal()">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-3 shrink-0">
                <h2 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-gear text-gray-600"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h2>
                <button onclick="closeSettingsModal()" class="text-gray-400 hover:text-red-500 w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="space-y-4">
                <p class="text-sm text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ:</p>
                <div>
                    <select id="system-approval-mode" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:ring-2 focus:ring-kmutnb-main text-sm font-medium">
                        <option value="auto">üü¢ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÜ 3 ‡∏ä‡∏°.)</option>
                        <option value="manual">üî¥ ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à)</option>
                    </select>
                </div>
                <button onclick="saveSettings()" class="w-full bg-gray-800 hover:bg-black text-white font-bold py-3 rounded-xl transition shadow-md">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                </button>
            </div>
        </div>
    </div>

    <div id="createModal" class="modal-overlay" onclick="if(event.target == this) closeCreateModal()">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-3 shrink-0">
                <h2 class="text-xl font-bold text-gray-800">‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà</h2>
                <button onclick="closeCreateModal()" class="text-gray-400 hover:text-red-500 w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="space-y-4 overflow-y-auto pr-2 hide-scrollbar">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà <span class="text-red-500">*</span></label>
                    <select id="post-category" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:ring-2 focus:ring-kmutnb-main text-sm">
                        <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà --</option>
                        <option value="study">üìö ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô / ‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£</option>
                        <option value="food">üçú ‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏ô / ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                        <option value="friend">üë• ‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô / ‡∏´‡∏≠‡∏û‡∏±‡∏Å</option>
                        <option value="general">üí¨ ‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ <span class="text-red-500">*</span></label>
                    <input type="text" id="post-title" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:ring-2 focus:ring-kmutnb-main text-sm" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à...">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                    <textarea id="post-content" rows="4" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:ring-2 focus:ring-kmutnb-main text-sm resize-none" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤..."></textarea>
                </div>
                <button onclick="checkAndSubmitPost()" class="w-full bg-kmutnb-main hover:bg-orange-600 text-white font-bold py-3 rounded-xl transition shadow-md">
                    ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ
                </button>
            </div>
        </div>
    </div>

    <div id="viewModal" class="modal-overlay" onclick="if(event.target == this) closeViewModal()">
        <div class="modal-content h-[90vh] !p-0 overflow-hidden relative flex flex-col">
            <div class="flex justify-between items-center p-4 border-b bg-white shrink-0 z-10">
                <h2 class="text-lg font-bold text-gray-800 line-clamp-1">‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ</h2>
                <button onclick="closeViewModal()" class="text-gray-400 hover:text-red-500 w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="overflow-y-auto flex-1 p-4 bg-gray-50 hide-scrollbar" id="view-post-body">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-4 relative" id="view-main-post">
                    </div>

                <h3 class="font-bold text-gray-700 mb-3 ml-1 text-sm"><i class="fa-regular fa-comments"></i> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô (<span id="view-comment-count">0</span>)</h3>
                <div id="view-comments-list" class="space-y-3 pb-4">
                    </div>
            </div>

            <div class="p-4 bg-white border-t shrink-0">
                <div class="flex gap-2">
                    <input type="hidden" id="reply-post-id">
                    <input type="text" id="reply-content" class="flex-1 px-4 py-2.5 bg-gray-100 rounded-full border-0 outline-none focus:ring-2 focus:ring-kmutnb-main text-sm" placeholder="‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô...">
                    <button onclick="submitComment()" class="w-11 h-11 bg-kmutnb-main text-white rounded-full flex items-center justify-center shadow-md hover:bg-orange-600 transition shrink-0">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://hcjquegorteantfzckpf.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_3bK3c4hh7hu37K0XxCzXVA_-5rJH89L'; 
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const userType = sessionStorage.getItem('userType') || 'guest';
        let currentUserName = "‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô"; 
        
        if (userType !== 'guest' && sessionStorage.getItem('userData')) {
            try {
                const userData = JSON.parse(sessionStorage.getItem('userData'));
                currentUserName = userData.full_name ? userData.full_name.split(' ')[0] : userData.username;
            } catch (e) { console.error("Error parsing userData", e); }
        }

        let roleDisplay = userType === 'admin' ? '<span class="text-red-500 font-bold">(Admin)</span>' : '';
        document.getElementById('display-username').innerHTML = `‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠: ${currentUserName} ${roleDisplay}`;

        let allPostsData = []; 
        let myPostsData = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
        let currentCategory = 'all';
        let currentApprovalMode = 'auto'; 
        
        const categoryInfo = {
            'study': { label: '‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', color: 'text-blue-600 bg-blue-50 border-blue-100' },
            'food': { label: '‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏ô', color: 'text-orange-600 bg-orange-50 border-orange-100' },
            'friend': { label: '‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô', color: 'text-green-600 bg-green-50 border-green-100' },
            'general': { label: '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', color: 'text-gray-600 bg-gray-100 border-gray-200' }
        };

        const badWordsList = ['‡∏™‡∏±‡∏™', '‡πÄ‡∏´‡∏µ‡πâ‡∏¢', '‡∏Ñ‡∏ß‡∏¢', '‡πÄ‡∏¢‡πá‡∏î', '‡∏´‡∏µ', '‡πÅ‡∏ï‡∏î', '‡∏°‡∏∂‡∏á', '‡∏Å‡∏π', '‡πÅ‡∏°‡πà‡∏á', '‡πÄ‡∏á‡∏µ‡πà‡∏¢‡∏ô', '‡πÄ‡∏™‡∏µ‡∏¢‡∏ß', '‡∏ä‡∏±‡∏Å‡∏ß‡πà‡∏≤‡∏ß', 'fuck', 'shit', 'porn', 'bitch', 'asshole'];

        function containsBadWords(text) {
            if (!text) return false;
            return badWordsList.some(word => text.includes(word));
        }

        function timeAgo(dateString) {
            const date = new Date(dateString);
            const diffInSeconds = Math.floor((new Date() - date) / 1000);
            if (diffInSeconds < 60) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
            if (diffInSeconds < 3600) return Math.floor(diffInSeconds / 60) + ' ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß';
            if (diffInSeconds < 86400) return Math.floor(diffInSeconds / 3600) + ' ‡∏ä‡∏°.‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß';
            return Math.floor(diffInSeconds / 86400) + ' ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß';
        }

        async function fetchSystemSettings() {
            try {
                const { data, error } = await supabaseClient.from('community_settings').select('*').eq('setting_key', 'approval_mode').single();
                if (data) currentApprovalMode = data.setting_value;
            } catch (e) { console.log("‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô"); }

            
        }

        async function fetchPosts() {
            document.getElementById('post-feed').innerHTML = '<div class="text-center py-10 text-gray-500"><i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>';
            
            let query = supabaseClient.from('community_posts')
                .select('*')
                .order('is_pinned', { ascending: false })
                .order('created_at', { ascending: false });
            
            if (userType !== 'admin') query = query.eq('status', 'approved');

            const { data, error } = await query;
            if (error) return console.error(error);
            allPostsData = data;
            renderPosts();
        }

        function renderPosts(filterText = '') {
            const feed = document.getElementById('post-feed');
            feed.innerHTML = '';
            
            let filteredPosts = allPostsData.filter(p => {
                const matchCat = currentCategory === 'all' || p.category === currentCategory;
                const matchTxt = p.title.toLowerCase().includes(filterText.toLowerCase()) || (p.content && p.content.toLowerCase().includes(filterText.toLowerCase()));
                return matchCat && matchTxt;
            });

            if (filteredPosts.length === 0) {
                feed.innerHTML = `<div class="text-center text-gray-400 py-10"><i class="fa-regular fa-folder-open text-4xl mb-3"></i><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ</p></div>`;
                return;
            }

            filteredPosts.forEach(post => {
                const cat = categoryInfo[post.category] || categoryInfo['general'];
                const isPending = post.status === 'pending';
                const isPinned = post.is_pinned;
                
                let cardStyle = 'border-gray-100 hover:border-kmutnb-light bg-white';
                if (isPinned) cardStyle = 'border-orange-300 bg-orange-50 shadow-md';
                if (isPending) cardStyle = 'border-yellow-400 bg-yellow-50 opacity-90';

                const badgePending = isPending ? `<span class="text-[10px] font-bold px-2 py-0.5 rounded-md bg-yellow-500 text-white ml-2">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>` : '';
                const badgePinned = isPinned ? `<span class="text-[10px] font-bold px-2 py-0.5 rounded-md bg-kmutnb-main text-white ml-1"><i class="fa-solid fa-thumbtack"></i> ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î</span>` : '';

                let adminControls = '';
                let reportControl = ''; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏°‡∏≤‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                if (userType === 'admin') {
                    const btnApprove = isPending ? `<button onclick="approvePost(event, ${post.id})" class="text-green-600 bg-green-100 px-2 py-1 rounded text-[10px] font-bold hover:bg-green-200">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>` : '';
                    const btnPinText = isPinned ? '‡πÄ‡∏•‡∏¥‡∏Å‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î' : '‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î';
                    const btnPinStyle = isPinned ? 'text-gray-600 bg-gray-200 hover:bg-gray-300' : 'text-blue-600 bg-blue-100 hover:bg-blue-200';
                    const btnPin = `<button onclick="togglePinPost(event, ${post.id}, ${isPinned})" class="${btnPinStyle} px-2 py-1 rounded text-[10px] font-bold transition"><i class="fa-solid fa-thumbtack"></i> ${btnPinText}</button>`;
                    
                    adminControls = `
                        <div class="absolute top-3 right-3 flex gap-2">
                            ${btnPin}
                            ${btnApprove}
                            <button onclick="adminDeletePost(event, ${post.id})" class="text-red-500 bg-red-100 px-2 py-1 rounded text-[10px] font-bold hover:bg-red-200"><i class="fa-solid fa-trash"></i> ‡∏•‡∏ö</button>
                        </div>
                    `;
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                    if (!isPending) {
                        reportControl = `
                            <div class="absolute top-3 right-3 flex gap-2">
                                <button onclick="reportPost(event, ${post.id})" class="text-gray-400 bg-gray-50 border border-gray-100 px-2 py-1 rounded text-[10px] font-bold hover:bg-red-50 hover:text-red-500 hover:border-red-200 transition">
                                    <i class="fa-solid fa-flag"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                                </button>
                            </div>
                        `;
                    }
                }

                feed.innerHTML += `
                    <div class="p-4 rounded-xl shadow-sm border transition cursor-pointer relative ${cardStyle}" onclick="openViewModal(${post.id})">
                        ${adminControls}
                        ${reportControl} <div class="flex items-center gap-2 mb-2 pr-32">
                            <span class="text-[10px] font-bold px-2 py-0.5 rounded-md border ${cat.color}">${cat.label}</span>
                            <span class="text-xs text-gray-400"><i class="fa-regular fa-clock"></i> ${timeAgo(post.created_at)}</span>
                            ${badgePinned}
                            ${badgePending}
                        </div>
                        <h3 class="font-bold text-gray-800 text-[15px] mb-1 line-clamp-2 pr-16">${post.title}</h3>
                        <p class="text-sm text-gray-500 line-clamp-2 mb-3">${post.content || ''}</p>
                        <div class="flex items-center justify-between text-xs text-gray-400 border-t border-gray-100 pt-3">
                            <div class="flex items-center gap-1.5 font-medium">
                                <img src="https://ui-avatars.com/api/?name=${post.author}&background=random&color=fff" class="w-5 h-5 rounded-full object-cover">
                                ${post.author}
                            </div>
                            <div><i class="fa-regular fa-comment-dots text-gray-400"></i> ${post.comments || 0} ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</div>
                        </div>
                    </div>`;
            });
        }

        // ==========================================
        // üö® ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin)
        // ==========================================

        // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        async function fetchReportBadge() {
            if (userType !== 'admin') return;

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏™‡πà‡∏ï‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î)
            document.getElementById('admin-settings-btn').style.display = 'flex';
            document.getElementById('admin-reports-btn').style.display = 'flex';

            const { count, error } = await supabaseClient
                .from('community_reports')
                .select('*', { count: 'exact', head: true })
                .eq('status', 'pending');

            const badge = document.getElementById('report-badge');
            if (count > 0) {
                badge.innerText = count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô
        fetchReportBadge(); 

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î Modal ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
        function openAdminReportsModal() {
            document.getElementById('adminReportsModal').style.display = 'flex';
            loadAdminReports();
        }

        function closeAdminReportsModal() {
            document.getElementById('adminReportsModal').style.display = 'none';
        }

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
        async function loadAdminReports() {
            const list = document.getElementById('admin-reports-list');
            list.innerHTML = '<div class="text-center py-10 text-gray-500"><i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></div>';

            // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ (Title, Content) ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢ (Join table)
            const { data, error } = await supabaseClient
                .from('community_reports')
                .select(`
                    id, reporter, reason, created_at, post_id,
                    community_posts ( title, content, author )
                `)
                .eq('status', 'pending')
                .order('created_at', { ascending: false });

            if (error) return console.error(error);

            if (!data || data.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-400 py-10"><i class="fa-regular fa-circle-check text-4xl mb-3"></i><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p></div>`;
                fetchReportBadge(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Å‡∏£‡∏∞‡∏î‡∏¥‡πà‡∏á
                return;
            }

            list.innerHTML = '';
            const reasonLabels = {
                'spam': '‡∏™‡πÅ‡∏õ‡∏° / ‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏Ç‡∏¢‡∏∞',
                'inappropriate': '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°',
                'harassment': '‡∏Ñ‡∏∏‡∏Å‡∏Ñ‡∏≤‡∏° / ‡∏Å‡∏•‡∏±‡πà‡∏ô‡πÅ‡∏Å‡∏•‡πâ‡∏á',
                'fake_news': '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡πá‡∏à',
                'other': '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
            };

            data.forEach(report => {
                const post = report.community_posts;
                if (!post) return; // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÇ‡∏î‡∏ô‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡πÄ‡∏•‡∏¢

                list.innerHTML += `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-red-200 mb-3">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[11px] font-bold px-2 py-1 rounded bg-red-50 text-red-600 border border-red-100">
                                <i class="fa-solid fa-triangle-exclamation"></i> ${reasonLabels[report.reason] || report.reason}
                            </span>
                            <span class="text-[10px] text-gray-400">${timeAgo(report.created_at)}</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-2">‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: <span class="font-bold text-gray-700">${report.reporter}</span></p>
                        
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-100 mb-3">
                            <h4 class="text-sm font-bold text-gray-800 mb-1">‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ: ${post.title}</h4>
                            <p class="text-xs text-gray-500 line-clamp-2">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤: ${post.content || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤'}</p>
                            <p class="text-[10px] text-gray-400 mt-2">‡πÇ‡∏î‡∏¢: ${post.author}</p>
                        </div>

                        <div class="flex gap-2 justify-end">
                            <button onclick="resolveReport(${report.id})" class="bg-white border border-gray-200 hover:bg-gray-50 text-gray-600 px-3 py-1.5 rounded-lg text-xs font-bold transition">
                                ‡πÄ‡∏û‡∏¥‡∏Å‡πÄ‡∏â‡∏¢ (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)
                            </button>
                            <button onclick="adminDeleteReportedPost(${report.post_id}, ${report.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition shadow-sm">
                                <i class="fa-solid fa-trash"></i> ‡∏•‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        // 4. ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£: ‡πÄ‡∏û‡∏¥‡∏Å‡πÄ‡∏â‡∏¢‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏¥‡∏ß)
        async function resolveReport(reportId) {
            await supabaseClient.from('community_reports').update({ status: 'resolved' }).eq('id', reportId);
            loadAdminReports(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
            fetchReportBadge(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Å‡∏£‡∏∞‡∏î‡∏¥‡πà‡∏á
        }

        // 5. ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£: ‡∏•‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ó‡∏¥‡πâ‡∏á
        async function adminDeleteReportedPost(postId, reportId) {
            Swal.fire({
                title: '‡∏•‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ?',
                text: "‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6B7280',
                confirmButtonText: '‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    // ‡∏•‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏´‡∏•‡∏±‡∏Å (‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥ Cascade ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Supabase ‡∏û‡∏ß‡∏Å Report ‡πÅ‡∏•‡∏∞ Comment ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
                    await supabaseClient.from('community_posts').delete().eq('id', postId);
                    
                    Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', showConfirmButton: false, timer: 1500 });
                    loadAdminReports(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                    fetchReportBadge(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                    fetchPosts();       // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å
                }
            });
        }
        // ==========================================
        // üü° ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ "‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô" (My Posts)
        // ==========================================
        function openMyPostsModal() {
            if (userType === 'guest') {
                return Swal.fire('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ', 'warning');
            }
            document.getElementById('myPostsModal').style.display = 'flex';
            fetchMyPosts();
        }

        function closeMyPostsModal() {
            document.getElementById('myPostsModal').style.display = 'none';
        }

        async function fetchMyPosts() {
            const list = document.getElementById('my-posts-list');
            list.innerHTML = '<div class="text-center py-10 text-gray-500"><i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>';

            const { data, error } = await supabaseClient.from('community_posts')
                .select('*')
                .eq('author', currentUserName)
                .order('created_at', { ascending: false });

            if (error) return console.error(error);
            myPostsData = data;
            
            if (myPostsData.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-400 py-10"><i class="fa-regular fa-folder-open text-4xl mb-3"></i><p>‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ</p></div>`;
                return;
            }

            list.innerHTML = '';
            myPostsData.forEach(post => {
                const cat = categoryInfo[post.category] || categoryInfo['general'];
                const isPending = post.status === 'pending';
                
                let statusBadge = `<span class="text-[10px] font-bold px-2 py-0.5 rounded-md bg-green-500 text-white">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>`;
                let editBtn = '';

                // ‡∏´‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                if (isPending) {
                    statusBadge = `<span class="text-[10px] font-bold px-2 py-0.5 rounded-md bg-yellow-500 text-white">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>`;
                    editBtn = `<button onclick="openEditPostModal(${post.id})" class="text-blue-500 bg-blue-50 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-100 transition"><i class="fa-solid fa-pen"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>`;
                }

                list.innerHTML += `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-3 relative">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-[10px] font-bold px-2 py-0.5 rounded-md border ${cat.color}">${cat.label}</span>
                            ${statusBadge}
                            <span class="text-xs text-gray-400 ml-auto">${timeAgo(post.created_at)}</span>
                        </div>
                        <h3 class="font-bold text-gray-800 text-sm mb-1">${post.title}</h3>
                        <p class="text-xs text-gray-500 line-clamp-2 mb-3">${post.content || ''}</p>
                        
                        <div class="flex justify-end gap-2 border-t border-gray-50 pt-2">
                            ${editBtn}
                            <button onclick="userDeletePost(${post.id})" class="text-red-500 bg-red-50 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-red-100 transition"><i class="fa-solid fa-trash"></i> ‡∏•‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ</button>
                        </div>
                    </div>
                `;
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
        async function userDeletePost(postId) {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
                text: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: '‡∏•‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await supabaseClient.from('community_posts').delete().eq('id', postId).eq('author', currentUserName);
                    Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÅ‡∏•‡πâ‡∏ß', timer: 1000, showConfirmButton: false });
                    fetchMyPosts(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                    fetchPosts();   // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                }
            });
        }
        
        // ==========================================
        // üî¥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ (Report)
        // ==========================================
        async function reportPost(event, postId) {
            event.stopPropagation(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ã‡πâ‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤

            if (userType === 'guest') {
                return Swal.fire('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ', 'warning');
            }

            // ‡πÅ‡∏™‡∏î‡∏á Pop-up ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
            const { value: reason } = await Swal.fire({
                title: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ',
                text: '‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏£‡∏≤‡∏ö',
                icon: 'warning',
                input: 'select',
                inputOptions: {
                    'spam': '‡∏™‡πÅ‡∏õ‡∏° / ‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏Ç‡∏¢‡∏∞',
                    'inappropriate': '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° / ‡∏•‡∏≤‡∏°‡∏Å‡∏≠‡∏ô‡∏≤‡∏à‡∏≤‡∏£ / ‡∏´‡∏¢‡∏≤‡∏ö‡∏Ñ‡∏≤‡∏¢',
                    'harassment': '‡∏Ñ‡∏∏‡∏Å‡∏Ñ‡∏≤‡∏° / ‡∏Å‡∏•‡∏±‡πà‡∏ô‡πÅ‡∏Å‡∏•‡πâ‡∏á / ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡∏•‡∏µ‡∏¢‡∏î‡∏ä‡∏±‡∏á',
                    'fake_news': '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡πá‡∏à / ‡∏´‡∏•‡∏≠‡∏Å‡∏•‡∏ß‡∏á',
                    'other': '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
                },
                inputPlaceholder: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...',
                showCancelButton: true,
                confirmButtonColor: '#EE3F0B',
                cancelButtonColor: '#6B7280',
                confirmButtonText: '‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                inputValidator: (value) => {
                    return new Promise((resolve) => {
                        if (value) {
                            resolve();
                        } else {
                            resolve('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô');
                        }
                    });
                }
            });

            if (reason) {
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Database Table: 'community_reports'
                const { error } = await supabaseClient.from('community_reports').insert([
                    { 
                        post_id: postId, 
                        reporter: currentUserName, 
                        reason: reason,
                        status: 'pending' // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                    }
                ]);

                if (error) {
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
                } else {
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        text: '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡πÑ‡∏õ',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            }
        }
        // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ
        function openEditPostModal(postId) {
            const post = myPostsData.find(p => p.id === postId);
            if (!post) return;

            document.getElementById('edit-post-id').value = post.id;
            document.getElementById('edit-post-category').value = post.category;
            document.getElementById('edit-post-title').value = post.title;
            document.getElementById('edit-post-content').value = post.content || '';
            
            document.getElementById('editPostModal').style.display = 'flex';
        }

        function closeEditPostModal() {
            document.getElementById('editPostModal').style.display = 'none';
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        async function submitEditPost() {
            const postId = document.getElementById('edit-post-id').value;
            const cat = document.getElementById('edit-post-category').value;
            const title = document.getElementById('edit-post-title').value;
            const content = document.getElementById('edit-post-content').value;

            if (!cat || !title) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠', 'error');

            if (containsBadWords(title) || containsBadWords(content)) {
                return Swal.fire({
                    icon: 'warning',
                    title: '‡∏û‡∏ö‡∏Ñ‡∏≥‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°!',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°',
                    confirmButtonColor: '#EE3F0B'
                });
            }

            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            const { error } = await supabaseClient.from('community_posts')
                .update({ title: title, content: content, category: cat, status: 'pending' }) // ‡∏¢‡πâ‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô pending ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                .eq('id', postId).eq('author', currentUserName);

            if (error) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
            } else {
                closeEditPostModal();
                Swal.fire({ icon: 'success', title: '‡∏™‡πà‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß', text: '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', timer: 1500, showConfirmButton: false });
                fetchMyPosts(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                fetchPosts();   // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            }
        }
        // ==========================================

        function setCategory(cat, btn) {
            currentCategory = cat;
            document.querySelectorAll('.cat-chip').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            handleSearch();
        }
        function handleSearch() { renderPosts(document.getElementById('search-input').value); }

        function openCreateModal() { document.getElementById('createModal').style.display = 'flex'; }
        function closeCreateModal() { 
            document.getElementById('createModal').style.display = 'none'; 
            document.getElementById('post-category').value = '';
            document.getElementById('post-title').value = '';
            document.getElementById('post-content').value = '';
        }

        function formatWaitTime(ms) {
            const totalMins = Math.floor(ms / 60000);
            const hrs = Math.floor(totalMins / 60);
            const mins = totalMins % 60;
            if (hrs > 0) return `${hrs} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${mins} ‡∏ô‡∏≤‡∏ó‡∏µ`;
            return `${mins} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        }

        async function checkAndSubmitPost() {
            const cat = document.getElementById('post-category').value;
            const title = document.getElementById('post-title').value;
            const content = document.getElementById('post-content').value;

            if (!cat || !title) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠', 'error');

            if (containsBadWords(title) || containsBadWords(content)) {
                return Swal.fire({
                    icon: 'warning',
                    title: '‡∏û‡∏ö‡∏Ñ‡∏≥‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°!',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (‡∏Ñ‡∏≥‡∏´‡∏¢‡∏≤‡∏ö / 18+)',
                    confirmButtonColor: '#EE3F0B'
                });
            }

            if (userType !== 'admin') {
                if (currentApprovalMode === 'manual') {
                    return Swal.fire({
                        title: '‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö',
                        text: '‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏û‡∏™‡∏ï‡πå ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonColor: '#EE3F0B',
                        cancelButtonColor: '#6B7280',
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á‡∏™‡πà‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ',
                        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
                    }).then((result) => {
                        if (result.isConfirmed) executeSubmit(cat, title, content, 'pending', '‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
                    });
                }

                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                const { data: lastPost } = await supabaseClient
                    .from('community_posts')
                    .select('created_at')
                    .eq('author', currentUserName)
                    .order('created_at', { ascending: false })
                    .limit(1);
                
                if (lastPost && lastPost.length > 0) {
                    const lastTime = new Date(lastPost[0].created_at).getTime();
                    const now = new Date().getTime();
                    const cooldownMs = 3 * 60 * 60 * 1000;
                    const timePassed = now - lastTime;

                    if (timePassed < cooldownMs) {
                        const timeLeft = cooldownMs - timePassed;
                        Swal.fire({
                            title: '‚è≥ ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...',
                            html: `‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÑ‡∏î‡πâ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ 3 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏≠‡∏µ‡∏Å: <b class="text-red-500">${formatWaitTime(timeLeft)}</b>`,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#EE3F0B',
                            cancelButtonColor: '#6B7280',
                            confirmButtonText: '<i class="fa-solid fa-flag"></i> ‡∏¢‡∏∑‡πà‡∏ô‡∏≠‡∏∏‡∏ó‡∏ò‡∏£‡∏ì‡πå‡∏î‡πà‡∏ß‡∏ô',
                            cancelButtonText: '‡∏õ‡∏¥‡∏î'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                executeSubmit(cat, title, content, 'pending', '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏∏‡∏ó‡∏ò‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∞‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÉ‡∏ô‡πÑ‡∏°‡πà‡∏ä‡πâ‡∏≤');
                            }
                        });
                        return;
                    }
                }
            }
            
            executeSubmit(cat, title, content, 'approved', '‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        async function executeSubmit(cat, title, content, statusToSave, successMessage) {
            closeCreateModal();
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            const { error } = await supabaseClient
                .from('community_posts')
                .insert([{ title, content, category: cat, author: currentUserName, status: statusToSave }]);
            
            if (error) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
            } else {
                const iconType = statusToSave === 'pending' ? 'info' : 'success';
                Swal.fire({ icon: iconType, title: successMessage, timer: 2000, showConfirmButton: false });
                fetchPosts();
            }
        }

        // ------------------ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á Admin ------------------
        function openSettingsModal() { document.getElementById('settingsModal').style.display = 'flex'; }
        function closeSettingsModal() { document.getElementById('settingsModal').style.display = 'none'; }
        
        async function saveSettings() {
            const mode = document.getElementById('system-approval-mode').value;
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            const { error } = await supabaseClient
                .from('community_settings')
                .upsert({ setting_key: 'approval_mode', setting_value: mode });
                
            if (error) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
            } else {
                currentApprovalMode = mode;
                closeSettingsModal();
                Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß', timer: 1500, showConfirmButton: false });
            }
        }

        async function adminDeletePost(event, postId) {
            event.stopPropagation();
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
                text: "‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await supabaseClient.from('community_posts').delete().eq('id', postId);
                    fetchPosts();
                }
            });
        }

        async function approvePost(event, postId) {
            event.stopPropagation();
            await supabaseClient.from('community_posts').update({ status: 'approved' }).eq('id', postId);
            Swal.fire({ icon: 'success', title: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß', timer: 1000, showConfirmButton: false });
            fetchPosts();
        }

        async function togglePinPost(event, postId, currentPinStatus) {
            event.stopPropagation();
            const newStatus = !currentPinStatus; 
            await supabaseClient.from('community_posts').update({ is_pinned: newStatus }).eq('id', postId);
            fetchPosts(); 
        }
        // -----------------------------------------------------

        async function openViewModal(postId) {
            const post = allPostsData.find(p => p.id === postId);
            if(!post) return;

            document.getElementById('viewModal').style.display = 'flex';
            document.getElementById('reply-post-id').value = postId;
            document.getElementById('reply-content').value = '';
            
            const cat = categoryInfo[post.category] || categoryInfo['general'];
            const badgePinned = post.is_pinned ? `<span class="text-[10px] font-bold px-2 py-0.5 rounded-md bg-kmutnb-main text-white inline-block mb-3 ml-2"><i class="fa-solid fa-thumbtack"></i> ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î</span>` : '';

            document.getElementById('view-main-post').innerHTML = `
                <div class="flex items-center gap-2 mb-3">
                    <img src="https://ui-avatars.com/api/?name=${post.author}&background=random&color=fff" class="w-8 h-8 rounded-full">
                    <div>
                        <div class="text-sm font-bold text-gray-800">${post.author}</div>
                        <div class="text-[10px] text-gray-400"><i class="fa-regular fa-clock"></i> ${timeAgo(post.created_at)}</div>
                    </div>
                </div>
                <h3 class="font-bold text-lg text-gray-800 mb-2 leading-tight">${post.title}</h3>
                <span class="text-[10px] font-bold px-2 py-0.5 rounded-md border inline-block mb-3 ${cat.color}">${cat.label}</span>
                ${badgePinned}
                <p class="text-sm text-gray-600 leading-relaxed whitespace-pre-wrap">${post.content || ''}</p>
            `;

            fetchComments(postId);
        }

        function closeViewModal() { document.getElementById('viewModal').style.display = 'none'; }

        async function fetchComments(postId) {
            const list = document.getElementById('view-comments-list');
            list.innerHTML = '<div class="text-center py-4 text-gray-400 text-sm"><i class="fa-solid fa-circle-notch fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';

            const { data, error } = await supabaseClient.from('community_comments').select('*').eq('post_id', postId).order('created_at', { ascending: true });
            if (error) return console.error(error);
            document.getElementById('view-comment-count').innerText = data.length;

            if (data.length === 0) {
                list.innerHTML = `<div class="text-center py-6 text-gray-400 text-sm bg-white rounded-xl border border-gray-100 shadow-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡πÄ‡∏•‡∏¢!</div>`;
                return;
            }

            list.innerHTML = '';
            data.forEach(comment => {
                let adminDelComment = userType === 'admin' ? `<button onclick="deleteComment(${comment.id}, ${postId})" class="text-red-400 hover:text-red-600 text-[10px] ml-auto"><i class="fa-solid fa-trash"></i></button>` : '';
                list.innerHTML += `
                    <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex gap-3">
                        <img src="https://ui-avatars.com/api/?name=${comment.author}&background=random&color=fff" class="w-8 h-8 rounded-full shrink-0">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-sm font-bold text-gray-800">${comment.author}</span>
                                <span class="text-[10px] text-gray-400">${timeAgo(comment.created_at)}</span>
                                ${adminDelComment}
                            </div>
                            <p class="text-sm text-gray-600 whitespace-pre-wrap">${comment.content}</p>
                        </div>
                    </div>`;
            });

            setTimeout(() => {
                const body = document.getElementById('view-post-body');
                body.scrollTop = body.scrollHeight;
            }, 100);
        }

        async function submitComment() {
            const postId = document.getElementById('reply-post-id').value;
            const content = document.getElementById('reply-content').value.trim();
            if (!content) return;

            if (containsBadWords(content)) {
                return Swal.fire({
                    icon: 'warning',
                    title: '‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°!',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ñ‡πâ‡∏≠‡∏¢‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô',
                    confirmButtonColor: '#EE3F0B'
                });
            }

            const inputField = document.getElementById('reply-content');
            inputField.disabled = true;

            const { error } = await supabaseClient.from('community_comments').insert([{ post_id: postId, content: content, author: currentUserName }]);
            if (error) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
                inputField.disabled = false; return;
            }

            const post = allPostsData.find(p => p.id == postId);
            const newCount = (post.comments || 0) + 1;
            await supabaseClient.from('community_posts').update({ comments: newCount }).eq('id', postId);
            
            post.comments = newCount; 
            inputField.value = '';
            inputField.disabled = false;
            fetchComments(postId);
            handleSearch();
        }

        async function deleteComment(commentId, postId) {
            if(confirm('‡∏•‡∏ö‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ô‡∏µ‡πâ?')) {
                await supabaseClient.from('community_comments').delete().eq('id', commentId);
                const post = allPostsData.find(p => p.id == postId);
                const newCount = Math.max(0, (post.comments || 0) - 1);
                await supabaseClient.from('community_posts').update({ comments: newCount }).eq('id', postId);
                post.comments = newCount;
                fetchComments(postId);
                handleSearch();
            }
        }

        document.getElementById('reply-content').addEventListener("keypress", function(event) {
            if (event.key === "Enter") { event.preventDefault(); submitComment(); }
        });

        // ‡∏î‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏î‡∏∂‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå
        fetchSystemSettings().then(() => fetchPosts());
    </script>
    <div id="adminReportsModal" class="modal-overlay" onclick="if(event.target == this) closeAdminReportsModal()">
        <div class="modal-content h-[85vh] !p-0 overflow-hidden relative flex flex-col">
            <div class="flex justify-between items-center p-4 border-b bg-white shrink-0 z-10">
                <h2 class="text-lg font-bold text-gray-800"><i class="fa-solid fa-flag text-red-500"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <button onclick="closeAdminReportsModal()" class="text-gray-400 hover:text-red-500 w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="overflow-y-auto flex-1 p-4 bg-gray-50 hide-scrollbar" id="admin-reports-list">
                </div>
        </div>
    </div>
</body>
</html>