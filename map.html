<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMUTNB Map - ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‡∏°‡∏à‡∏û.</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kmutnb: { main: '#EE3F0B', light: '#FF6B42' }
                    },
                    fontFamily: { sans: ['Prompt', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Prompt', sans-serif; }
        #map { height: calc(100vh - 64px); width: 100%; z-index: 0; }
        
        /* --- Custom Marker Styles --- */
        .custom-pin {
            background-color: white;
            border-radius: 50%;
            border: 2px solid;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s, background-color 0.2s;
        }
        .custom-pin:hover {
            transform: scale(1.15);
            z-index: 1000 !important;
        }

        /* Color Coding */
        .pin-faculty { border-color: #EE3F0B; color: #EE3F0B; }
        .pin-faculty:hover { background-color: #EE3F0B; color: white; border-color: white; }

        .pin-facility { border-color: #2563EB; color: #2563EB; }
        .pin-facility:hover { background-color: #2563EB; color: white; border-color: white; }

        .pin-transport { border-color: #9333EA; color: #9333EA; }
        .pin-transport:hover { background-color: #9333EA; color: white; border-color: white; }

        .pin-food { border-color: #D97706; color: #D97706; }
        .pin-food:hover { background-color: #D97706; color: white; border-color: white; }

        .pin-service { border-color: #059669; color: #059669; }
        .pin-service:hover { background-color: #059669; color: white; border-color: white; }

        .pin-other { border-color: #4B5563; color: #4B5563; }
        .pin-other:hover { background-color: #4B5563; color: white; border-color: white; }

        /* Popup Styles */
        .leaflet-popup-content a { text-decoration: none !important; color: white !important; }
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; }

        /* --- UI Components --- */
        .search-container {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 420px; /* Mobile Default Width */
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: max-width 0.3s ease;
        }
        
        .search-results {
            max-height: 250px;
            overflow-y: auto;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Filter Chips Scrollbar (Mobile Default) */
        .filter-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 4px;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .filter-scroll::-webkit-scrollbar { display: none; }

        .filter-chip {
            white-space: nowrap;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            background-color: white;
            color: #4B5563;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #E5E7EB;
            transition: all 0.2s;
            cursor: pointer;
        }
        .filter-chip.active {
            background-color: #EE3F0B;
            color: white;
            border-color: #EE3F0B;
        }

        /* --- Desktop Responsive Tweaks --- */
        @media (min-width: 768px) {
            .search-container {
                max-width: 700px; /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô‡∏à‡∏≠‡∏Ñ‡∏≠‡∏° */
            }
            
            .filter-scroll {
                overflow-x: visible; /* ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô */
                flex-wrap: wrap;     /* ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô */
                justify-content: center; /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
            }

            .filter-chip {
                padding: 8px 16px; /* ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏ö‡∏ô‡∏Ñ‡∏≠‡∏° */
                font-size: 14px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden flex flex-col">

    <header class="bg-white shadow-md z-20 h-16 flex items-center justify-between px-4">
        <div class="flex items-center gap-3">
            <a href="index.html" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 transition">
                <i class="fa-solid fa-arrow-left"></i>
            </a>
            <div>
                <h1 class="text-lg font-bold text-gray-800 leading-none">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‡∏°‡∏à‡∏û.</h1>
                <span id="user-status-text" class="text-xs text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
            </div>
        </div>

        <button onclick="handleTopRightButton()" id="action-btn" class="bg-kmutnb-main hover:bg-orange-700 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg transition flex items-center gap-2">
            <i class="fa-regular fa-comment-dots"></i>
            <span id="action-btn-text">‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</span>
        </button>
    </header>

    <div class="relative flex-1">
        
        <div class="search-container">
            <div class="relative w-full">
                <input type="text" id="search-input" oninput="handleSearch()" 
                    class="w-full h-11 pl-11 pr-4 rounded-full shadow-md border-0 outline-none focus:ring-2 focus:ring-orange-500 text-gray-700 font-sans" 
                    placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£, ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥...">
                <div class="absolute left-4 top-3 text-gray-400">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </div>
                <button onclick="clearSearch()" id="clear-search-btn" class="hidden absolute right-3 top-3 text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="filter-scroll px-1" id="filter-container">
                <button class="filter-chip active" onclick="setFilter('all', this)">
                    <i class="fa-solid fa-layer-group mr-1"></i> ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
                <button class="filter-chip" onclick="setFilter('building', this)">
                    <i class="fa-solid fa-building mr-1"></i> ‡∏ï‡∏∂‡∏Å/‡∏Ñ‡∏ì‡∏∞
                </button>
                <button class="filter-chip" onclick="setFilter('food', this)">
                    <i class="fa-solid fa-utensils mr-1"></i> ‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏ô
                </button>
                <button class="filter-chip" onclick="setFilter('transport', this)">
                    <i class="fa-solid fa-elevator mr-1"></i> ‡∏•‡∏¥‡∏ü‡∏ï‡πå/‡∏ö‡∏±‡∏ô‡πÑ‡∏î
                </button>
                <button class="filter-chip" onclick="setFilter('service', this)">
                    <i class="fa-solid fa-chair mr-1"></i> ‡∏ô‡∏±‡πà‡∏á‡∏û‡∏±‡∏Å/‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤
                </button>
            </div>
            
            <div id="search-results-box" class="search-results bg-white hidden"></div>
        </div>

        <div id="map" class="h-full w-full"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Config Supabase
        const SUPABASE_URL = 'https://hcjquegorteantfzckpf.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_3bK3c4hh7hu37K0XxCzXVA_-5rJH89L'; 
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // State Variables
        let userData = JSON.parse(sessionStorage.getItem('userData')) || {};
        let userType = sessionStorage.getItem('userType') || 'guest';
        if(userData.role === 'admin') userType = 'admin';

        let map;
        let markers = {}; 
        let allBuildingsData = []; 
        let currentFilter = 'all';

        // --------------------------------------------------------
        // 1. Initialization
        // --------------------------------------------------------
        const KMUTNB_LAT = 13.819077;
        const KMUTNB_LNG = 100.514332;
        const ZOOM_THRESHOLD = 17;

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([KMUTNB_LAT, KMUTNB_LNG], 17);
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            fetchBuildings();

            map.on('click', function(e) {
                document.getElementById('search-results-box').classList.add('hidden');
                if (userType === 'admin') openAddPinModal(e.latlng.lat, e.latlng.lng);
            });

            map.on('zoomend', function() {
                renderPins(allBuildingsData);
            });
        }

        function updateUI() {
            const statusText = document.getElementById('user-status-text');
            const btnText = document.getElementById('action-btn-text');
            
            if (userType === 'admin') {
                statusText.innerText = 'Admin: ‡πÅ‡∏ï‡∏∞‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° / ‡πÅ‡∏ï‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
                statusText.className = 'text-xs text-red-600 font-bold';
                btnText.innerText = '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£';
            } else {
                statusText.innerText = 'Zoom ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
                statusText.className = 'text-xs text-gray-500';
                btnText.innerText = '‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤';
            }
        }

        // --------------------------------------------------------
        // 2. Logic: Filter & Zoom Visibility
        // --------------------------------------------------------
        const CATEGORIES = {
            building: ['faculty', 'facility'],
            food: ['coffee', 'food'],
            transport: ['stairs', 'elevator'],
            service: ['rest', 'entrance', 'other']
        };

        function setFilter(category, btnElement) {
            currentFilter = category;
            document.querySelectorAll('.filter-chip').forEach(btn => btn.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
            renderPins(allBuildingsData);
            
            const statusText = document.getElementById('user-status-text');
            if (category === 'all') {
                statusText.innerText = '‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ã‡∏π‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)';
            } else {
                statusText.innerText = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏á: ${btnElement.innerText}`;
            }
        }

        function shouldShowMarker(type) {
            const currentZoom = map.getZoom();
            if (currentFilter !== 'all') {
                const allowedTypes = CATEGORIES[currentFilter] || [];
                return allowedTypes.includes(type);
            }
            if (['faculty', 'facility'].includes(type)) return true;
            return currentZoom >= ZOOM_THRESHOLD;
        }

        function renderPins(buildings) {
            for (let id in markers) map.removeLayer(markers[id]);
            markers = {};
            if (!buildings) return;

            buildings.forEach(b => {
                if (!shouldShowMarker(b.type)) return;

                const pin = getPinStyle(b.type);
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="custom-pin ${pin.style}" style="width: ${pin.size}px; height: ${pin.size}px;">
                            <i class="fa-solid ${pin.icon}"></i>
                           </div>`,
                    iconSize: [pin.size, pin.size],
                    iconAnchor: [pin.size/2, pin.size], 
                    popupAnchor: [0, -10]
                });

                const marker = L.marker([b.lat, b.lng], { icon: customIcon }).addTo(map);
                
                let popupContent = `
                    <div class="font-sans min-w-[200px]">
                        <div class="bg-gray-800 text-white p-2 text-center rounded-t-lg">
                            <h3 class="font-bold text-base leading-tight">${b.name}</h3>
                        </div>
                        <div class="p-3 border border-t-0 rounded-b-lg bg-white">
                            <div class="text-xs font-bold ${pin.color} mb-2 flex items-center gap-1">
                                <i class="fa-solid ${pin.icon}"></i> ${pin.label}
                            </div>
                            <div class="text-sm text-gray-600 mb-3 whitespace-pre-line">${b.details || '-'}</div>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${b.lat},${b.lng}" target="_blank" 
                               class="bg-blue-600 hover:bg-blue-700 !text-white text-xs px-3 py-2 rounded block text-center mb-2">
                               <i class="fa-solid fa-location-arrow"></i> ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
                            </a>
                `;

                if (userType === 'admin') {
                    popupContent += `
                        <div class="flex gap-2 w-full pt-2 border-t">
                            <button onclick="window.openEditPinModal(${b.id})" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white text-xs px-2 py-1.5 rounded">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button onclick="window.deletePin(${b.id})" class="flex-1 bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1.5 rounded">‡∏•‡∏ö</button>
                        </div>
                    `;
                }

                popupContent += `</div></div>`;
                marker.bindPopup(popupContent);
                markers[b.id] = marker; 
            });
        }

        function getPinStyle(type) {
            switch(type) {
                case 'faculty': return { icon: 'fa-graduation-cap', style: 'pin-faculty', label: '‡∏Ñ‡∏ì‡∏∞/‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£', color: 'text-kmutnb-main', size: 34 };
                case 'facility': return { icon: 'fa-building-columns', style: 'pin-facility', label: '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á', color: 'text-blue-600', size: 34 };
                case 'stairs': return { icon: 'fa-stairs', style: 'pin-transport', label: '‡∏ö‡∏±‡∏ô‡πÑ‡∏î', color: 'text-purple-600', size: 26 };
                case 'elevator': return { icon: 'fa-elevator', style: 'pin-transport', label: '‡∏•‡∏¥‡∏ü‡∏ï‡πå', color: 'text-purple-600', size: 26 };
                case 'coffee': return { icon: 'fa-mug-hot', style: 'pin-food', label: '‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡πâ‡∏≥/‡∏Å‡∏≤‡πÅ‡∏ü', color: 'text-yellow-600', size: 28 };
                case 'food': return { icon: 'fa-utensils', style: 'pin-food', label: '‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', color: 'text-yellow-600', size: 28 };
                case 'rest': return { icon: 'fa-chair', style: 'pin-service', label: '‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏û‡∏±‡∏Å', color: 'text-green-600', size: 26 };
                case 'entrance': return { icon: 'fa-door-open', style: 'pin-service', label: '‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å', color: 'text-green-600', size: 26 };
                default: return { icon: 'fa-map-pin', style: 'pin-other', label: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ', color: 'text-gray-600', size: 26 };
            }
        }

        // --------------------------------------------------------
        // 3. Supabase & Admin
        // --------------------------------------------------------
        async function fetchBuildings() {
            try {
                const { data, error } = await supabaseClient.from('buildings').select('*');
                if (error) throw error;
                allBuildingsData = data;
                renderPins(data);
            } catch (err) { console.error(err); }
        }

        async function addBuildingToSupabase(name, type, details, lat, lng) {
            const { error } = await supabaseClient.from('buildings').insert([{ name, type, details, lat, lng }]);
            if (!error) { Swal.fire({icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1000, showConfirmButton:false}); fetchBuildings(); }
        }

        async function updateBuildingInSupabase(id, name, type, details) {
            const { error } = await supabaseClient.from('buildings').update({ name, type, details }).eq('id', id);
            if (!error) { Swal.fire({icon: 'success', title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1000, showConfirmButton:false}); fetchBuildings(); }
        }

        window.deletePin = async function(id) {
            Swal.fire({
                title: '‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await supabaseClient.from('buildings').delete().eq('id', id);
                    Swal.fire('Deleted!', '', 'success'); fetchBuildings();
                }
            });
        }

        function getLegacyTypeOptions(selectedType = '') {
            const types = [
                { val: 'faculty', label: 'üè´ ‡∏Ñ‡∏ì‡∏∞/‡∏ï‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' },
                { val: 'facility', label: 'üèõÔ∏è ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á/‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î' },
                { val: 'coffee', label: '‚òï ‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡πâ‡∏≥/‡∏Å‡∏≤‡πÅ‡∏ü' },
                { val: 'food', label: 'üç≤ ‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£' },
                { val: 'stairs', label: 'ü™ú ‡∏ö‡∏±‡∏ô‡πÑ‡∏î' },
                { val: 'elevator', label: 'üõó ‡∏•‡∏¥‡∏ü‡∏ï‡πå' },
                { val: 'rest', label: 'ü™ë ‡∏à‡∏∏‡∏î‡∏ô‡∏±‡πà‡∏á‡∏û‡∏±‡∏Å' },
                { val: 'entrance', label: 'üö™ ‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å' },
                { val: 'other', label: 'üìç ‡∏≠‡∏∑‡πà‡∏ô‡πÜ' }
            ];
            return types.map(t => `<option value="${t.val}" ${selectedType === t.val ? 'selected' : ''}>${t.label}</option>`).join('');
        }

        async function openAddPinModal(lat, lng) {
            const { value: formValues } = await Swal.fire({
                title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà',
                html:
                    `<input id="swal-name" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà">` +
                    `<select id="swal-type" class="swal2-input">${getLegacyTypeOptions()}</select>` +
                    `<textarea id="swal-details" class="swal2-textarea" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"></textarea>`,
                focusConfirm: false, showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', confirmButtonColor: '#EE3F0B',
                preConfirm: () => {
                    const name = document.getElementById('swal-name').value;
                    const type = document.getElementById('swal-type').value;
                    const details = document.getElementById('swal-details').value;
                    if (!name) Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠');
                    return [name, type, details];
                }
            });
            if (formValues) addBuildingToSupabase(formValues[0], formValues[1], formValues[2], lat, lng);
        }

        window.openEditPinModal = async function(id) {
            const b = allBuildingsData.find(x => x.id === id);
            if (!b) return;
            const { value: val } = await Swal.fire({
                title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',
                html:
                    `<input id="edit-name" class="swal2-input" value="${b.name}">` +
                    `<select id="edit-type" class="swal2-input">${getLegacyTypeOptions(b.type)}</select>` +
                    `<textarea id="edit-details" class="swal2-textarea">${b.details || ''}</textarea>`,
                focusConfirm: false, showCancelButton: true, confirmButtonText: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï', confirmButtonColor: '#F59E0B',
                preConfirm: () => [
                    document.getElementById('edit-name').value,
                    document.getElementById('edit-type').value,
                    document.getElementById('edit-details').value
                ]
            });
            if (val) updateBuildingInSupabase(id, val[0], val[1], val[2]);
        }

        function handleTopRightButton() {
            if (userType === 'admin') {
                Swal.fire({ title: 'Admin', text: '‡πÅ‡∏ï‡∏∞‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° / ‡πÅ‡∏ï‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', icon: 'info', confirmButtonColor: '#EE3F0B' });
            } else {
                openReportModal();
            }
        }

        async function openReportModal() {
            const { value: text } = await Swal.fire({
                title: '‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤', input: 'textarea', showCancelButton: true, confirmButtonText: '‡∏™‡πà‡∏á', confirmButtonColor: '#EE3F0B'
            });
            if (text) {
                await supabaseClient.from('reports').insert([{ description: '[WEB] ' + text, reporter_name: userData.full_name || 'Guest', status: 'pending' }]);
                Swal.fire('‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß', '', 'success');
            }
        }

        // --------------------------------------------------------
        // 4. Search
        // --------------------------------------------------------
        function handleSearch() {
            const q = document.getElementById('search-input').value.toLowerCase();
            const box = document.getElementById('search-results-box');
            document.getElementById('clear-search-btn').classList.toggle('hidden', !q);
            
            if (!q) { box.classList.add('hidden'); return; }

            const filtered = allBuildingsData.filter(b => b.name.toLowerCase().includes(q) || (b.details && b.details.toLowerCase().includes(q)));
            
            if (filtered.length === 0) {
                box.innerHTML = `<div class="p-4 text-center text-gray-500 text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
            } else {
                box.innerHTML = filtered.map(b => {
                    const p = getPinStyle(b.type);
                    return `
                        <div onclick="selectLocation(${b.id})" class="p-3 border-b border-gray-100 hover:bg-orange-50 cursor-pointer flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center ${p.color}"><i class="fa-solid ${p.icon}"></i></div>
                            <div class="overflow-hidden"><div class="font-bold text-gray-800 text-sm truncate">${b.name}</div><div class="text-xs text-gray-500">${p.label}</div></div>
                        </div>`;
                }).join('');
            }
            box.classList.remove('hidden');
        }

        function selectLocation(id) {
            const b = allBuildingsData.find(x => x.id === id);
            if (!b) return;
            map.flyTo([b.lat, b.lng], 19, { animate: true, duration: 1.2 });
            setTimeout(() => { if(markers[id]) markers[id].openPopup(); }, 1200);
            document.getElementById('search-input').value = b.name;
            document.getElementById('search-results-box').classList.add('hidden');
        }

        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-results-box').classList.add('hidden');
            document.getElementById('clear-search-btn').classList.add('hidden');
        }

        updateUI();
        initMap();
    </script>
</body>
</html>