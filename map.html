<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMUTNB Map - ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‡∏°‡∏à‡∏û.</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kmutnb: { main: '#EE3F0B', light: '#FF6B42' },
                        theme: { pink: '#E85B81' }
                    },
                    fontFamily: { sans: ['Prompt', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Prompt', sans-serif; }
        #map { height: calc(100vh - 64px); width: 100%; z-index: 0; }
        
        /* --- Custom Marker Styles --- */
        .custom-pin {
            background-color: white;
            border-radius: 50%;
            border: 2px solid;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s, background-color 0.2s;
        }
        .custom-pin:hover { transform: scale(1.15); z-index: 1000 !important; }

        .pin-faculty { border-color: #EE3F0B; color: #EE3F0B; }
        .pin-faculty:hover { background-color: #EE3F0B; color: white; border-color: white; }
        .pin-facility { border-color: #2563EB; color: #2563EB; }
        .pin-facility:hover { background-color: #2563EB; color: white; border-color: white; }
        
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå */
        .pin-sacred { border-color: #D4AF37; color: #D4AF37; }
        .pin-sacred:hover { background-color: #D4AF37; color: white; border-color: white; }

        .pin-transport { border-color: #9333EA; color: #9333EA; }
        .pin-transport:hover { background-color: #9333EA; color: white; border-color: white; }
        .pin-food { border-color: #D97706; color: #D97706; }
        .pin-food:hover { background-color: #D97706; color: white; border-color: white; }
        .pin-service { border-color: #059669; color: #059669; }
        .pin-service:hover { background-color: #059669; color: white; border-color: white; }
        .pin-other { border-color: #4B5563; color: #4B5563; }
        .pin-other:hover { background-color: #4B5563; color: white; border-color: white; }

        /* --- Custom Popup Styles --- */
        .leaflet-popup-content-wrapper {
            border-radius: 20px;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            background: #ffffff;
        }
        .leaflet-popup-content {
            margin: 0;
            width: 340px !important;
            max-width: 90vw;
        }
        .leaflet-popup-close-button { display: none !important; }
        .leaflet-popup-tip-container { width: 30px; height: 15px; }
        .leaflet-popup-tip { background: #ffffff; box-shadow: 0 10px 10px rgba(0,0,0,0.1); }

        /* --- UI Components --- */
        .search-container {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 420px; z-index: 1000;
            display: flex; flex-direction: column; gap: 10px;
        }
        .search-results { max-height: 250px; overflow-y: auto; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .filter-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
        .filter-scroll::-webkit-scrollbar { display: none; }
        .filter-chip {
            white-space: nowrap; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 500;
            background-color: white; color: #4B5563; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid #E5E7EB; cursor: pointer;
        }
        .filter-chip.active { background-color: #EE3F0B; color: white; border-color: #EE3F0B; }

        @media (min-width: 768px) {
            .search-container { max-width: 700px; }
            .filter-scroll { overflow-x: visible; flex-wrap: wrap; justify-content: center; }
            .filter-chip { padding: 8px 16px; font-size: 14px; }
        }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden flex flex-col">

    <header class="bg-white shadow-md z-20 h-16 flex items-center justify-between px-4">
        <div class="flex items-center gap-3">
            <a href="index.html" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 transition">
                <i class="fa-solid fa-arrow-left"></i>
            </a>
            <div>
                <h1 class="text-lg font-bold text-gray-800 leading-none">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‡∏°‡∏à‡∏û.</h1>
                <span id="user-status-text" class="text-xs text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
            </div>
        </div>
        <button onclick="handleTopRightButton()" id="action-btn" class="bg-kmutnb-main hover:bg-orange-700 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg transition flex items-center gap-2">
            <i class="fa-regular fa-comment-dots"></i>
            <span id="action-btn-text">‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</span>
        </button>
    </header>

    <div class="relative flex-1">
        <div class="search-container">
            <div class="relative w-full">
                <input type="text" id="search-input" oninput="handleSearch()" class="w-full h-11 pl-11 pr-4 rounded-full shadow-md border-0 outline-none focus:ring-2 focus:ring-orange-500 text-gray-700 font-sans" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£, ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥...">
                <div class="absolute left-4 top-3 text-gray-400"><i class="fa-solid fa-magnifying-glass"></i></div>
                <button onclick="clearSearch()" id="clear-search-btn" class="hidden absolute right-3 top-3 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="filter-scroll px-1" id="filter-container">
                <button class="filter-chip active" onclick="setFilter('all', this)"><i class="fa-solid fa-layer-group mr-1"></i> ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button class="filter-chip" onclick="setFilter('building', this)"><i class="fa-solid fa-building mr-1"></i> ‡∏ï‡∏∂‡∏Å/‡∏Ñ‡∏ì‡∏∞</button>
                <button class="filter-chip" onclick="setFilter('sacred', this)"><i class="fa-solid fa-place-of-worship mr-1"></i> ‡∏™‡∏¥‡πà‡∏á‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>
                <button class="filter-chip" onclick="setFilter('food', this)"><i class="fa-solid fa-utensils mr-1"></i> ‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏ô</button>
                <button class="filter-chip" onclick="setFilter('transport', this)"><i class="fa-solid fa-elevator mr-1"></i> ‡∏•‡∏¥‡∏ü‡∏ï‡πå/‡∏ö‡∏±‡∏ô‡πÑ‡∏î</button>
                <button class="filter-chip" onclick="setFilter('service', this)"><i class="fa-solid fa-chair mr-1"></i> ‡∏ô‡∏±‡πà‡∏á‡∏û‡∏±‡∏Å/‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤</button>
            </div>
            <div id="search-results-box" class="search-results bg-white hidden"></div>
        </div>
        <div id="map" class="h-full w-full"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Config Supabase
        const SUPABASE_URL = 'https://hcjquegorteantfzckpf.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_3bK3c4hh7hu37K0XxCzXVA_-5rJH89L'; 
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let userData = JSON.parse(sessionStorage.getItem('userData')) || {};
        let userType = sessionStorage.getItem('userType') || 'guest';
        if(userData.role === 'admin') userType = 'admin';

        let map;
        let markers = {}; 
        let allBuildingsData = []; 
        let currentFilter = 'all';

        const KMUTNB_LAT = 13.819077;
        const KMUTNB_LNG = 100.514332;
        const ZOOM_THRESHOLD = 17;

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([KMUTNB_LAT, KMUTNB_LNG], 17);
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                maxZoom: 22,
                maxNativeZoom: 19,
                attribution: '¬© OpenStreetMap contributors' 
            }).addTo(map);

            fetchBuildings();

            map.on('click', function(e) {
                document.getElementById('search-results-box').classList.add('hidden');
                if (userType === 'admin') openAddPinModal(e.latlng.lat, e.latlng.lng);
            });

            map.on('zoomend', function() { renderPins(allBuildingsData); });
        }

        function updateUI() {
            const statusText = document.getElementById('user-status-text');
            const btnText = document.getElementById('action-btn-text');
            if (userType === 'admin') {
                statusText.innerText = 'Admin: ‡πÅ‡∏ï‡∏∞‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° / ‡πÅ‡∏ï‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
                statusText.className = 'text-xs text-red-600 font-bold';
                btnText.innerText = '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£';
            } else {
                statusText.innerText = 'Zoom ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
                statusText.className = 'text-xs text-gray-500';
                btnText.innerText = '‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤';
            }
        }

        const CATEGORIES = {
            building: ['faculty', 'facility'],
            sacred: ['sacred'],
            food: ['coffee', 'food'],
            transport: ['stairs', 'elevator'],
            service: ['rest', 'entrance', 'other']
        };

        function setFilter(category, btnElement) {
            currentFilter = category;
            document.querySelectorAll('.filter-chip').forEach(btn => btn.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
            renderPins(allBuildingsData);
        }

        function shouldShowMarker(type) {
            const currentZoom = map.getZoom();

            if (currentZoom >= 20) {
                if (['faculty', 'facility'].includes(type)) return false;
            }

            if (currentFilter !== 'all') {
                const allowedTypes = CATEGORIES[currentFilter] || [];
                return allowedTypes.includes(type);
            }

            if (['faculty', 'facility', 'sacred'].includes(type)) return true;

            return currentZoom >= ZOOM_THRESHOLD;
        }

        window.closeCustomPopup = function() {
            map.closePopup();
        }

        function renderPins(buildings) {
            for (let id in markers) map.removeLayer(markers[id]);
            markers = {};
            if (!buildings) return;

            buildings.forEach(b => {
                if (!shouldShowMarker(b.type)) return;

                const pin = getPinStyle(b.type);
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="custom-pin ${pin.style}" style="width: ${pin.size}px; height: ${pin.size}px;">
                            <i class="fa-solid ${pin.icon}"></i>
                           </div>`,
                    iconSize: [pin.size, pin.size],
                    iconAnchor: [pin.size/2, pin.size], 
                    popupAnchor: [0, -10]
                });

                const marker = L.marker([b.lat, b.lng], { icon: customIcon }).addTo(map);
                
                let imageHtml = '';
                if (b.image_url && b.image_url.trim() !== '') {
                    imageHtml = `
                    <div class="w-full h-40 mt-3 mb-4 rounded-xl overflow-hidden shadow-inner border border-gray-100 relative bg-gray-50">
                        <img src="${b.image_url}" class="w-full h-full object-cover" alt="‡∏£‡∏π‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà" onerror="this.style.display='none'">
                    </div>`;
                }

                let popupContent = `
                    <div class="font-sans bg-white p-5 pb-4 relative">
                        <button onclick="window.closeCustomPopup()" class="absolute top-4 right-4 w-7 h-7 bg-orange-500 text-white rounded-full flex items-center justify-center hover:bg-orange-600 transition shadow-md z-10">
                            <i class="fa-solid fa-xmark text-sm"></i>
                        </button>

                        <h2 class="text-[22px] font-bold text-gray-800 pr-8 leading-tight tracking-tight">${b.name}</h2>
                        <div class="text-[13px] font-medium ${pin.color} mt-1 mb-4 flex items-center gap-1.5">
                            <i class="fa-solid ${pin.icon}"></i> ${pin.label}
                        </div>

                        <a href="https://www.google.com/maps/dir/?api=1&destination=${b.lat},${b.lng}" target="_blank" 
                            class="inline-flex items-center justify-center gap-2 bg-orange-500 hover:bg-orange-600 text-white px-5 py-2.5 rounded-full text-sm font-semibold transition !text-white !no-underline shadow-sm w-[110px]">
                            <i class="fa-solid fa-location-arrow"></i> ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
                        </a>

                        <hr class="border-gray-200 mt-5 mb-4">

                        ${imageHtml}

                        <h3 class="text-orange-500 font-bold text-lg mb-2">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h3>
                        <div class="flex items-start gap-2 mb-2">
                            <i class="fa-solid fa-location-dot text-orange-500 mt-1"></i>
                            <p class="text-sm text-gray-600 leading-relaxed">${b.details ? b.details : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°'}</p>
                        </div>
                `;

                if (userType === 'admin') {
                    popupContent += `
                        <div class="flex gap-2 w-full pt-4 mt-2 border-t border-gray-100">
                            <button onclick="window.openEditPinModal(${b.id})" class="flex-1 bg-yellow-500 hover:bg-yellow-600 transition text-white text-xs font-bold px-3 py-2.5 rounded-lg shadow-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                            <button onclick="window.deletePin(${b.id})" class="flex-1 bg-[#EE3F0B] hover:bg-red-700 transition text-white text-xs font-bold px-3 py-2.5 rounded-lg shadow-sm">‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ</button>
                        </div>
                    `;
                }

                popupContent += `</div>`;
                marker.bindPopup(popupContent);
                markers[b.id] = marker; 
            });
        }

        function getPinStyle(type) {
            switch(type) {
                case 'faculty': return { icon: 'fa-graduation-cap', style: 'pin-faculty', label: '‡∏Ñ‡∏ì‡∏∞/‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£', color: 'text-[#EE3F0B]', size: 34 };
                case 'facility': return { icon: 'fa-building-columns', style: 'pin-facility', label: '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á', color: 'text-[#EE3F0B]', size: 34 };
                case 'sacred': return { icon: 'fa-place-of-worship', style: 'pin-sacred', label: '‡∏™‡∏¥‡πà‡∏á‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå/‡∏®‡∏≤‡∏•', color: 'text-[#D4AF37]', size: 32 };
                case 'stairs': return { icon: 'fa-stairs', style: 'pin-transport', label: '‡∏ö‡∏±‡∏ô‡πÑ‡∏î', color: 'text-purple-600', size: 26 };
                case 'elevator': return { icon: 'fa-elevator', style: 'pin-transport', label: '‡∏•‡∏¥‡∏ü‡∏ï‡πå', color: 'text-purple-600', size: 26 };
                case 'coffee': return { icon: 'fa-mug-hot', style: 'pin-food', label: '‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡πâ‡∏≥/‡∏Å‡∏≤‡πÅ‡∏ü', color: 'text-yellow-600', size: 28 };
                case 'food': return { icon: 'fa-utensils', style: 'pin-food', label: '‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', color: 'text-yellow-600', size: 28 };
                case 'rest': return { icon: 'fa-chair', style: 'pin-service', label: '‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏û‡∏±‡∏Å', color: 'text-green-600', size: 26 };
                case 'entrance': return { icon: 'fa-door-open', style: 'pin-service', label: '‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å', color: 'text-green-600', size: 26 };
                default: return { icon: 'fa-map-pin', style: 'pin-other', label: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ', color: 'text-gray-600', size: 26 };
            }
        }

        async function fetchBuildings() {
            try {
                const { data, error } = await supabaseClient.from('buildings').select('*');
                if (error) throw error;
                allBuildingsData = data;
                renderPins(data);
            } catch (err) { console.error(err); }
        }

        async function addBuildingToSupabase(name, type, details, image_url, lat, lng) {
            const { error } = await supabaseClient.from('buildings').insert([{ name, type, details, image_url, lat, lng }]);
            if (!error) { Swal.fire({icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1000, showConfirmButton:false}); fetchBuildings(); }
        }

        async function updateBuildingInSupabase(id, name, type, details, image_url) {
            const { error } = await supabaseClient.from('buildings').update({ name, type, details, image_url }).eq('id', id);
            if (!error) { Swal.fire({icon: 'success', title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1000, showConfirmButton:false}); fetchBuildings(); }
        }

        window.deletePin = async function(id) {
            Swal.fire({
                title: '‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#EE3F0B', confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await supabaseClient.from('buildings').delete().eq('id', id);
                    Swal.fire('Deleted!', '', 'success'); fetchBuildings();
                }
            });
        }

        function getLegacyTypeOptions(selectedType = '') {
            const types = [
                { val: 'faculty', label: 'üè´ ‡∏Ñ‡∏ì‡∏∞/‡∏ï‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' },
                { val: 'facility', label: 'üèõÔ∏è ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á/‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î' },
                { val: 'sacred', label: 'üôè ‡∏™‡∏¥‡πà‡∏á‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå/‡∏®‡∏≤‡∏•' },
                { val: 'coffee', label: '‚òï ‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡πâ‡∏≥/‡∏Å‡∏≤‡πÅ‡∏ü' },
                { val: 'food', label: 'üç≤ ‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£' },
                { val: 'stairs', label: 'ü™ú ‡∏ö‡∏±‡∏ô‡πÑ‡∏î' },
                { val: 'elevator', label: 'üõó ‡∏•‡∏¥‡∏ü‡∏ï‡πå' },
                { val: 'rest', label: 'ü™ë ‡∏à‡∏∏‡∏î‡∏ô‡∏±‡πà‡∏á‡∏û‡∏±‡∏Å' },
                { val: 'entrance', label: 'üö™ ‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å' },
                { val: 'other', label: 'üìç ‡∏≠‡∏∑‡πà‡∏ô‡πÜ' }
            ];
            return types.map(t => `<option value="${t.val}" ${selectedType === t.val ? 'selected' : ''}>${t.label}</option>`).join('');
        }

        async function openAddPinModal(lat, lng) {
            const { value: formValues } = await Swal.fire({
                title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà',
                html:
                    `<input id="swal-name" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà">` +
                    `<select id="swal-type" class="swal2-input">${getLegacyTypeOptions()}</select>` +
                    `<input id="swal-image" class="swal2-input" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (URL) - ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö">` +
                    `<textarea id="swal-details" class="swal2-textarea" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"></textarea>`,
                focusConfirm: false, showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', confirmButtonColor: '#EE3F0B',
                preConfirm: () => {
                    const name = document.getElementById('swal-name').value;
                    const type = document.getElementById('swal-type').value;
                    const image_url = document.getElementById('swal-image').value;
                    const details = document.getElementById('swal-details').value;
                    if (!name) Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠');
                    return [name, type, details, image_url];
                }
            });
            if (formValues) addBuildingToSupabase(formValues[0], formValues[1], formValues[2], formValues[3], lat, lng);
        }

        window.openEditPinModal = async function(id) {
            const b = allBuildingsData.find(x => x.id === id);
            if (!b) return;
            const { value: val } = await Swal.fire({
                title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',
                html:
                    `<input id="edit-name" class="swal2-input" value="${b.name}">` +
                    `<select id="edit-type" class="swal2-input">${getLegacyTypeOptions(b.type)}</select>` +
                    `<input id="edit-image" class="swal2-input" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (URL)" value="${b.image_url || ''}">` +
                    `<textarea id="edit-details" class="swal2-textarea">${b.details || ''}</textarea>`,
                focusConfirm: false, showCancelButton: true, confirmButtonText: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï', confirmButtonColor: '#F59E0B',
                preConfirm: () => [
                    document.getElementById('edit-name').value,
                    document.getElementById('edit-type').value,
                    document.getElementById('edit-details').value,
                    document.getElementById('edit-image').value
                ]
            });
            if (val) updateBuildingInSupabase(id, val[0], val[1], val[2], val[3]);
        }

        function handleTopRightButton() {
            if (userType === 'admin') {
                Swal.fire({ title: 'Admin', text: '‡πÅ‡∏ï‡∏∞‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° / ‡πÅ‡∏ï‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', icon: 'info', confirmButtonColor: '#EE3F0B' });
            } else {
                openReportModal();
            }
        }

        async function openReportModal() {
            const { value: text } = await Swal.fire({
                title: '‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤', input: 'textarea', showCancelButton: true, confirmButtonText: '‡∏™‡πà‡∏á', confirmButtonColor: '#EE3F0B'
            });
            if (text) {
                await supabaseClient.from('reports').insert([{ description: '[WEB] ' + text, reporter_name: userData.full_name || 'Guest', status: 'pending' }]);
                Swal.fire('‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß', '', 'success');
            }
        }

        function handleSearch() {
            const q = document.getElementById('search-input').value.toLowerCase();
            const box = document.getElementById('search-results-box');
            document.getElementById('clear-search-btn').classList.toggle('hidden', !q);
            
            if (!q) { box.classList.add('hidden'); return; }

            const filtered = allBuildingsData.filter(b => b.name.toLowerCase().includes(q) || (b.details && b.details.toLowerCase().includes(q)));
            
            if (filtered.length === 0) {
                box.innerHTML = `<div class="p-4 text-center text-gray-500 text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
            } else {
                box.innerHTML = filtered.map(b => {
                    const p = getPinStyle(b.type);
                    return `
                        <div onclick="selectLocation(${b.id})" class="p-3 border-b border-gray-100 hover:bg-orange-50 cursor-pointer flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center ${p.color}"><i class="fa-solid ${p.icon}"></i></div>
                            <div class="overflow-hidden"><div class="font-bold text-gray-800 text-sm truncate">${b.name}</div><div class="text-xs text-gray-500">${p.label}</div></div>
                        </div>`;
                }).join('');
            }
            box.classList.remove('hidden');
        }

        function selectLocation(id) {
            const b = allBuildingsData.find(x => x.id === id);
            if (!b) return;
            document.getElementById('search-input').value = b.name;
            document.getElementById('search-results-box').classList.add('hidden');
            const allBtn = document.querySelector('.filter-chip'); 
            setFilter('all', allBtn);
            map.flyTo([b.lat, b.lng], 18, { animate: true, duration: 1.2 });
            map.once('moveend', function() {
                setTimeout(() => { if(markers[id]) markers[id].openPopup(); }, 100);
            });
        }

        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-results-box').classList.add('hidden');
            document.getElementById('clear-search-btn').classList.add('hidden');
        }

        updateUI();
        initMap();
    </script>
</body>
</html>