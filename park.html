<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMUTNB Parking - ที่จอดรถ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kmutnb: { main: '#EE3F0B', light: '#FF6B42' }
                    },
                    fontFamily: { sans: ['Prompt', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Prompt', sans-serif; }
        #map { height: calc(100vh - 120px); width: 100%; z-index: 0; } /* Adjusted height for filters */
        
        /* Custom Marker Style */
        .custom-pin {
            background-color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 16px;
            padding-top: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s;
            border: 2px solid;
        }
        .custom-pin:hover {
            transform: scale(1.1);
            color: white !important;
            /* Border and BG color set inline or via specific classes on hover would need !important or specific class logic, 
               simplifying to text color white for now as bg is set dynamically */
        }

        /* Marker Types (Border & Text Colors) */
        .pin-staff { border-color: #EE3F0B; color: #EE3F0B; } /* ส้ม - บุคลากร */
        .pin-student { border-color: #2563EB; color: #2563EB; } /* ฟ้า - นักศึกษา/บุคคลทั่วไป */
        
        /* Hover States (Backgrounds) */
        .pin-staff:hover { background-color: #EE3F0B; }
        .pin-student:hover { background-color: #2563EB; }

        /* Status: Full overrides border color? Maybe just an indicator inside? 
           Let's keep the type color dominant, and maybe change icon or add a badge for full.
           Or, use red border for full as requested in previous logic, but that conflicts with user type colors.
           Let's use a red background or icon for full status to differentiate. 
           Current requirement: Color based on User Type (Staff=Orange, Student=Blue).
           Let's keep status text in popup. */

        /* Popup Styles */
        .leaflet-popup-content a {
            text-decoration: none !important;
            color: white !important;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 0;
        }
        .leaflet-popup-content {
            margin: 10px;
        }

        /* Filter Buttons */
        .filter-btn {
            @apply px-4 py-2 rounded-full text-sm font-medium border transition-colors;
        }
        .filter-btn.active {
            @apply bg-kmutnb-main text-white border-kmutnb-main;
        }
        .filter-btn.inactive {
            @apply bg-white text-gray-600 border-gray-300 hover:bg-gray-50;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden flex flex-col">

    <header class="bg-white shadow-md z-20 h-16 flex items-center justify-between px-4 shrink-0">
        <div class="flex items-center gap-3">
            <a href="index.html" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 transition">
                <i class="fa-solid fa-arrow-left"></i>
            </a>
            <div>
                <h1 class="text-lg font-bold text-gray-800 leading-none">จุดจอดรถ มจพ.</h1>
                <span id="user-status-text" class="text-xs text-gray-500">กำลังโหลด...</span>
            </div>
        </div>

        <button onclick="handleTopRightButton()" id="action-btn" class="bg-kmutnb-main hover:bg-orange-700 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg transition flex items-center gap-2">
            <i class="fa-regular fa-comment-dots"></i>
            <span id="action-btn-text">แจ้งปัญหา</span>
        </button>
    </header>

    <div class="bg-white border-b px-4 py-2 flex gap-2 overflow-x-auto whitespace-nowrap z-10 shrink-0">
        <button onclick="setFilter('all')" id="filter-all" class="filter-btn active">ทั้งหมด</button>
        <button onclick="setFilter('car')" id="filter-car" class="filter-btn inactive"><i class="fa-solid fa-car"></i> รถยนต์</button>
        <button onclick="setFilter('motorcycle')" id="filter-motorcycle" class="filter-btn inactive"><i class="fa-solid fa-motorcycle"></i> มอเตอร์ไซค์</button>
    </div>

    <div id="map" class="relative flex-grow"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --------------------------------------------------------
        // Config Supabase
        // --------------------------------------------------------
        const SUPABASE_URL = 'https://hcjquegorteantfzckpf.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_3bK3c4hh7hu37K0XxCzXVA_-5rJH89L'; 
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --------------------------------------------------------
        // 1. User & Session Management
        // --------------------------------------------------------
        let userData = JSON.parse(sessionStorage.getItem('userData')) || {};
        let userType = sessionStorage.getItem('userType') || 'guest';
        
        if(userData.role === 'admin') userType = 'admin';

        function updateUI() {
            const statusText = document.getElementById('user-status-text');
            const btnText = document.getElementById('action-btn-text');
            const btnIcon = document.querySelector('#action-btn i');

            if (userType === 'admin') {
                statusText.innerText = 'โหมดผู้ดูแล: แตะแผนที่เพิ่มหมุด / แตะหมุดเพื่อแก้ไข';
                statusText.className = 'text-xs text-red-600 font-bold';
                btnText.innerText = 'จัดการระบบ';
                btnIcon.className = 'fa-solid fa-map-pin';
            } else {
                statusText.innerText = 'แตะที่หมุดเพื่อนำทาง';
                statusText.className = 'text-xs text-gray-500';
                btnText.innerText = 'แจ้งปัญหา';
                btnIcon.className = 'fa-regular fa-comment-dots';
            }
        }

        // --------------------------------------------------------
        // 2. Map Initialization & Global Variables
        // --------------------------------------------------------
        const KMUTNB_LAT = 13.819077;
        const KMUTNB_LNG = 100.514332;
        let map;
        let markers = [];
        let allSpotsData = []; 
        let currentFilter = 'all'; // all, car, motorcycle

        function initMap() {
            map = L.map('map').setView([KMUTNB_LAT, KMUTNB_LNG], 17);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            fetchParkingSpots();

            map.on('click', function(e) {
                if (userType === 'admin') {
                    openAddPinModal(e.latlng.lat, e.latlng.lng);
                }
            });
        }

        // --------------------------------------------------------
        // 3. Supabase Operations
        // --------------------------------------------------------

        // READ
        async function fetchParkingSpots() {
            try {
                const { data, error } = await supabaseClient
                    .from('parking_spots')
                    .select('*')
                    .order('id', { ascending: true });

                if (error) throw error;
                
                allSpotsData = data; 
                renderPins(); // Render based on current filter

            } catch (err) {
                console.error('Error fetching spots:', err);
                Swal.fire('Error', 'ไม่สามารถโหลดข้อมูลที่จอดรถได้', 'error');
            }
        }

        // CREATE
        async function addSpotToSupabase(name, vehicleType, userGroup, capacity, lat, lng) {
            try {
                const { error } = await supabaseClient
                    .from('parking_spots')
                    .insert([{ 
                        name, 
                        type: vehicleType,      // car, motorcycle
                        user_group: userGroup,  // staff, student (New Field)
                        capacity, 
                        lat, 
                        lng, 
                        status: 'available' 
                    }]);

                if (error) throw error;
                Swal.fire({ icon: 'success', title: 'บันทึกสำเร็จ', timer: 1500, showConfirmButton: false });
                fetchParkingSpots(); 
            } catch (err) {
                Swal.fire('Error', 'ไม่สามารถเพิ่มหมุดได้ (ตรวจสอบ DB schema field "user_group")', 'error');
            }
        }

        // UPDATE
        async function updateSpotInSupabase(id, name, vehicleType, userGroup, capacity, status) {
            try {
                const { error } = await supabaseClient
                    .from('parking_spots')
                    .update({ 
                        name, 
                        type: vehicleType, 
                        user_group: userGroup, 
                        capacity, 
                        status 
                    })
                    .eq('id', id);

                if (error) throw error;
                Swal.fire({ icon: 'success', title: 'แก้ไขเรียบร้อย', timer: 1500, showConfirmButton: false });
                fetchParkingSpots(); 
            } catch (err) {
                console.error(err);
                Swal.fire('Error', 'แก้ไขข้อมูลไม่สำเร็จ', 'error');
            }
        }

        // DELETE
        window.deletePin = async function(id) {
            Swal.fire({
                title: 'ยืนยันการลบ?',
                text: "ข้อมูลจะถูกลบออกจากฐานข้อมูลทันที",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'ลบเลย'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const { error } = await supabaseClient.from('parking_spots').delete().eq('id', id);
                        if (error) throw error;
                        Swal.fire('Deleted!', 'ลบหมุดเรียบร้อยแล้ว', 'success');
                        fetchParkingSpots(); 
                    } catch (err) {
                        Swal.fire('Error', 'ลบไม่สำเร็จ', 'error');
                    }
                }
            });
        }

        // --------------------------------------------------------
        // 4. Render Pins & Filter Logic
        // --------------------------------------------------------
        
        function setFilter(type) {
            currentFilter = type;
            
            // Update UI buttons
            ['all', 'car', 'motorcycle'].forEach(t => {
                const btn = document.getElementById(`filter-${t}`);
                if(t === type) {
                    btn.className = 'filter-btn active';
                } else {
                    btn.className = 'filter-btn inactive';
                }
            });

            renderPins();
        }

        function renderPins() {
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            if (!allSpotsData) return;

            // Filter data
            const spotsToRender = currentFilter === 'all' 
                ? allSpotsData 
                : allSpotsData.filter(s => s.type === currentFilter);

            spotsToRender.forEach(spot => {
                // Logic: Icon (Car/Moto) & Color (Staff/Student)
                const isCar = spot.type === 'car';
                const iconClass = isCar ? 'fa-car' : 'fa-motorcycle';
                
                // Color Logic: Staff = Orange, Student/Public = Blue
                // Default to 'student' style if user_group is missing
                const isStaff = spot.user_group === 'staff';
                const styleClass = isStaff ? 'pin-staff' : 'pin-student';
                
                const statusText = spot.status === 'full' 
                    ? '<span class="text-red-500 font-bold">เต็ม</span>' 
                    : '<span class="text-green-500 font-bold">ว่าง</span>';

                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="custom-pin ${styleClass}" style="width: 32px; height: 32px;">
                            <i class="fa-solid ${iconClass}"></i>
                           </div>`,
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                    popupAnchor: [0, -35]
                });

                const marker = L.marker([spot.lat, spot.lng], { icon: customIcon }).addTo(map);
                
                let popupContent = `
                    <div class="text-center font-sans p-1 min-w-[200px]">
                        <h3 class="font-bold text-lg text-gray-800 mb-1">${spot.name}</h3>
                        <div class="text-sm font-bold mb-1 ${isStaff ? 'text-kmutnb-main' : 'text-blue-600'}">
                            ${isStaff ? 'เฉพาะครูเเละบุคลากร ' : 'นักศึกษาเเละบุคคลทั่วไป '}
                        </div>
                        <div class="text-sm text-gray-600 mb-2">
                            สถานะ: ${statusText} <br>
                            <span class="text-xs text-gray-400">ความจุ: ${spot.capacity || '-'} คัน</span>
                        </div>
                        <div class="flex gap-2 justify-center mt-2 flex-wrap">
                `;

                popupContent += `
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${spot.lat},${spot.lng}" target="_blank" 
                       class="bg-blue-600 hover:bg-blue-700 !text-white text-xs px-3 py-1.5 rounded-lg flex items-center gap-1 shadow transition"
                       style="color: white !important;">
                       <i class="fa-solid fa-location-arrow"></i> นำทาง
                    </a>
                `;

                if (userType === 'admin') {
                    popupContent += `
                        <button onclick="window.openEditPinModal(${spot.id})" class="bg-yellow-500 hover:bg-yellow-600 text-white text-xs px-3 py-1.5 rounded-lg shadow flex items-center gap-1">
                           <i class="fa-solid fa-pen-to-square"></i> แก้ไข
                        </button>
                        <button onclick="window.deletePin(${spot.id})" class="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1.5 rounded-lg shadow flex items-center gap-1">
                           <i class="fa-solid fa-trash"></i> ลบ
                        </button>
                    `;
                }

                popupContent += `</div></div>`;
                marker.bindPopup(popupContent);
                markers.push(marker);
            });
        }

        // --------------------------------------------------------
        // 5. UI Handlers & Modals
        // --------------------------------------------------------

        function handleTopRightButton() {
            if (userType === 'admin') {
                Swal.fire({
                    title: 'โหมดผู้ดูแลระบบ',
                    text: 'แตะที่ว่างบนแผนที่เพื่อเพิ่มหมุด หรือแตะที่หมุดเพื่อแก้ไข/ลบ',
                    icon: 'info',
                    confirmButtonText: 'รับทราบ',
                    confirmButtonColor: '#EE3F0B'
                });
            } else {
                openReportModal();
            }
        }

        async function openReportModal() {
            const { value: text } = await Swal.fire({
                title: 'แจ้งปัญหาที่จอดรถ',
                input: 'textarea',
                inputLabel: 'ระบุปัญหาที่พบ',
                inputPlaceholder: 'เช่น ไฟส่องสว่างเสีย...',
                showCancelButton: true,
                confirmButtonText: 'ส่งรายงาน',
                confirmButtonColor: '#EE3F0B'
            });

            if (text) {
                try {
                    const reporterName = userData.full_name || 'Guest User';
                    await supabaseClient.from('reports').insert([{ 
                        description: text, 
                        reporter_name: reporterName,
                        status: 'pending'
                    }]);
                    Swal.fire('ขอบคุณ', 'ส่งรายงานเรียบร้อยแล้ว', 'success');
                } catch (err) {
                    Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถส่งรายงานได้', 'error');
                }
            }
        }

        // Modal: เพิ่มหมุด (Admin)
        async function openAddPinModal(lat, lng) {
            const { value: formValues } = await Swal.fire({
                title: 'เพิ่มจุดจอดรถใหม่',
                html:
                    `<div class="text-left text-sm text-gray-500 mb-1">ชื่อจุดจอด</div>` +
                    `<input id="swal-name" class="swal2-input" placeholder="ชื่อจุดจอด" style="margin-top:0;">` +
                    
                    `<div class="text-left text-sm text-gray-500 mt-3 mb-1">ประเภทรถ</div>` +
                    `<select id="swal-type" class="swal2-input" style="margin-top:0;">
                        <option value="car">รถยนต์</option>
                        <option value="motorcycle">มอเตอร์ไซค์</option>
                    </select>` +

                    `<div class="text-left text-sm text-gray-500 mt-3 mb-1">กลุ่มผู้ใช้งาน (สีหมุด)</div>` +
                    `<select id="swal-group" class="swal2-input" style="margin-top:0;">
                        <option value="student">นักศึกษา/บุคคลทั่วไป (ฟ้า)</option>
                        <option value="staff">บุคลากร/ครู (ส้ม)</option>
                    </select>` +
                    
                    `<div class="text-left text-sm text-gray-500 mt-3 mb-1">ความจุ</div>` +
                    `<input id="swal-cap" class="swal2-input" placeholder="เช่น 50 คัน" style="margin-top:0;">`,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'บันทึก',
                confirmButtonColor: '#EE3F0B',
                preConfirm: () => {
                    const name = document.getElementById('swal-name').value;
                    const type = document.getElementById('swal-type').value;
                    const group = document.getElementById('swal-group').value;
                    const cap = document.getElementById('swal-cap').value;
                    if (!name) Swal.showValidationMessage('กรุณาใส่ชื่อจุดจอด');
                    return [name, type, group, cap];
                }
            });

            if (formValues) {
                // args: name, vehicleType, userGroup, capacity, lat, lng
                addSpotToSupabase(formValues[0], formValues[1], formValues[2], formValues[3], lat, lng);
            }
        }

        // Modal: แก้ไขหมุด (Admin)
        window.openEditPinModal = async function(id) {
            const spot = allSpotsData.find(s => s.id === id);
            if (!spot) return;

            const { value: formValues } = await Swal.fire({
                title: 'แก้ไขข้อมูลจุดจอด',
                html:
                    `<div class="text-left text-sm text-gray-500 mb-1">ชื่อจุดจอด</div>` +
                    `<input id="edit-name" class="swal2-input" value="${spot.name}" style="margin-top:0;">` +
                    
                    `<div class="text-left text-sm text-gray-500 mt-3 mb-1">สถานะ (ว่าง/เต็ม)</div>` +
                    `<select id="edit-status" class="swal2-input" style="margin-top:0;">
                        <option value="available" ${spot.status === 'available' ? 'selected' : ''}>ว่าง (สีเขียว)</option>
                        <option value="full" ${spot.status === 'full' ? 'selected' : ''}>เต็ม (สีแดง)</option>
                    </select>` +

                    `<div class="text-left text-sm text-gray-500 mt-3 mb-1">ประเภทรถ</div>` +
                    `<select id="edit-type" class="swal2-input" style="margin-top:0;">
                        <option value="car" ${spot.type === 'car' ? 'selected' : ''}>รถยนต์</option>
                        <option value="motorcycle" ${spot.type === 'motorcycle' ? 'selected' : ''}>มอเตอร์ไซค์</option>
                    </select>` +

                    `<div class="text-left text-sm text-gray-500 mt-3 mb-1">กลุ่มผู้ใช้งาน (สีหมุด)</div>` +
                    `<select id="edit-group" class="swal2-input" style="margin-top:0;">
                        <option value="student" ${spot.user_group === 'student' ? 'selected' : ''}>นักศึกษา/บุคคลทั่วไป (ฟ้า)</option>
                        <option value="staff" ${spot.user_group === 'staff' ? 'selected' : ''}>บุคลากร/ครู (ส้ม)</option>
                    </select>` +
                    
                    `<div class="text-left text-sm text-gray-500 mt-3 mb-1">ความจุ</div>` +
                    `<input id="edit-cap" class="swal2-input" value="${spot.capacity}" style="margin-top:0;">`,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'อัปเดต',
                confirmButtonColor: '#F59E0B', 
                preConfirm: () => {
                    const name = document.getElementById('edit-name').value;
                    const status = document.getElementById('edit-status').value;
                    const type = document.getElementById('edit-type').value;
                    const group = document.getElementById('edit-group').value;
                    const cap = document.getElementById('edit-cap').value;
                    if (!name) Swal.showValidationMessage('กรุณาใส่ชื่อจุดจอด');
                    return [name, type, group, cap, status];
                }
            });

            if (formValues) {
                // args: id, name, vehicleType, userGroup, capacity, status
                updateSpotInSupabase(id, formValues[0], formValues[1], formValues[2], formValues[3], formValues[4]);
            }
        }

        // Start App
        updateUI();
        initMap();

    </script>
</body>
</html>